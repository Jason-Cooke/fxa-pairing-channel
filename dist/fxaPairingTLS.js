!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("fxaPairingTLS",[],e):"object"==typeof exports?exports.fxaPairingTLS=e():t.fxaPairingTLS=e()}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=18)}([function(t,e,n){t.exports=n(16)},function(t,e){function n(t,e,n,r,i,a,s){try{var c=t[a](s),u=c.value}catch(t){return void n(t)}c.done?e(u):Promise.resolve(u).then(r,i)}t.exports=function(t){return function(){var e=this,r=arguments;return new Promise(function(i,a){var s=t.apply(e,r);function c(t){n(s,i,a,c,u,"next",t)}function u(t){n(s,i,a,c,u,"throw",t)}c(void 0)})}}},function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function n(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}t.exports=function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}},function(t,e){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},n(e)}t.exports=n},function(t,e,n){var r=n(9),i=n(10);t.exports=function(t,e){return!e||"object"!==r(e)&&"function"!=typeof e?i(t):e}},function(t,e,n){var r=n(12);t.exports=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}},function(t,e,n){n(4);var r=n(11);function i(e,n,a){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=i=Reflect.get:t.exports=i=function(t,e,n){var i=r(t,e);if(i){var a=Object.getOwnPropertyDescriptor(i,e);return a.get?a.get.call(n):a.value}},i(e,n,a||e)}t.exports=i},function(t,e,n){var r=n(13),i=n(14),a=n(15);t.exports=function(t,e){return r(t)||i(t,e)||a()}},function(t,e){function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(e){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?t.exports=r=function(t){return n(t)}:t.exports=r=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":n(t)},r(e)}t.exports=r},function(t,e){t.exports=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}},function(t,e,n){var r=n(4);t.exports=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=r(t)););return t}},function(t,e){function n(e,r){return t.exports=n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},n(e,r)}t.exports=n},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}},function(t,e){t.exports=function(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var s,c=t[Symbol.iterator]();!(r=(s=c.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{r||null==c.return||c.return()}finally{if(i)throw a}}return n}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(t,e,n){var r=function(){return this||"object"==typeof self&&self}()||Function("return this")(),i=r.regeneratorRuntime&&Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime")>=0,a=i&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,t.exports=n(17),i)r.regeneratorRuntime=a;else try{delete r.regeneratorRuntime}catch(t){r.regeneratorRuntime=void 0}},function(t,e){!function(e){"use strict";var n,r=Object.prototype,i=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",u=a.toStringTag||"@@toStringTag",o="object"==typeof t,f=e.regeneratorRuntime;if(f)o&&(t.exports=f);else{(f=e.regeneratorRuntime=o?t.exports:{}).wrap=_;var h="suspendedStart",p="suspendedYield",l="executing",d="completed",y={},v={};v[s]=function(){return this};var w=Object.getPrototypeOf,x=w&&w(w(T([])));x&&x!==r&&i.call(x,s)&&(v=x);var k=E.prototype=m.prototype=Object.create(v);b.prototype=k.constructor=E,E.constructor=b,E[u]=b.displayName="GeneratorFunction",f.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},f.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,E):(t.__proto__=E,u in t||(t[u]="GeneratorFunction")),t.prototype=Object.create(k),t},f.awrap=function(t){return{__await:t}},U(S.prototype),S.prototype[c]=function(){return this},f.AsyncIterator=S,f.async=function(t,e,n,r){var i=new S(_(t,e,n,r));return f.isGeneratorFunction(e)?i:i.next().then(function(t){return t.done?t.value:i.next()})},U(k),k[u]="Generator",k[s]=function(){return this},k.toString=function(){return"[object Generator]"},f.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},f.values=T,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(L),!t)for(var e in this)"t"===e.charAt(0)&&i.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=n)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(r,i){return c.type="throw",c.arg=t,e.next=r,i&&(e.method="next",e.arg=n),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a],c=s.completion;if("root"===s.tryLoc)return r("end");if(s.tryLoc<=this.prev){var u=i.call(s,"catchLoc"),o=i.call(s,"finallyLoc");if(u&&o){if(this.prev<s.catchLoc)return r(s.catchLoc,!0);if(this.prev<s.finallyLoc)return r(s.finallyLoc)}else if(u){if(this.prev<s.catchLoc)return r(s.catchLoc,!0)}else{if(!o)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return r(s.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=t,s.arg=e,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),L(n),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;L(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:T(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=n),y}}}function _(t,e,n,r){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new B(r||[]);return a._invoke=function(t,e,n){var r=h;return function(i,a){if(r===l)throw new Error("Generator is already running");if(r===d){if("throw"===i)throw a;return O()}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=V(s,n);if(c){if(c===y)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===h)throw r=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=l;var u=g(t,e,n);if("normal"===u.type){if(r=n.done?d:p,u.arg===y)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=d,n.method="throw",n.arg=u.arg)}}}(t,n,s),a}function g(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function m(){}function b(){}function E(){}function U(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function S(t){var e;this._invoke=function(n,r){function a(){return new Promise(function(e,a){!function e(n,r,a,s){var c=g(t[n],t,r);if("throw"!==c.type){var u=c.arg,o=u.value;return o&&"object"==typeof o&&i.call(o,"__await")?Promise.resolve(o.__await).then(function(t){e("next",t,a,s)},function(t){e("throw",t,a,s)}):Promise.resolve(o).then(function(t){u.value=t,a(u)},function(t){return e("throw",t,a,s)})}s(c.arg)}(n,r,e,a)})}return e=e?e.then(a,a):a()}}function V(t,e){var r=t.iterator[e.method];if(r===n){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=n,V(t,e),"throw"===e.method))return y;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var i=g(r,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,y;var a=i.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=n),e.delegate=null,y):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,y)}function A(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function B(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(A,this),this.reset(!0)}function T(t){if(t){var e=t[s];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function e(){for(;++r<t.length;)if(i.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=n,e.done=!0,e};return a.next=a}}return{next:O}}function O(){return{value:n,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())},function(t,e,n){"use strict";n.r(e);var r=n(5),i=n.n(r),a=n(4),s=n.n(a),c=n(7),u=n.n(c),o=n(6),f=n.n(o),h=n(8),p=n.n(h),l=n(0),d=n.n(l),y=n(1),v=n.n(y),w=n(2),x=n.n(w),k=n(3),_=n.n(k);function g(){}function m(t,e){if(!t)throw new Error("assert failed: "+e)}function b(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"value must be a Uint8Array";return m(t instanceof Uint8Array,e),t}function E(t){return m("string"==typeof t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"value must be a string"),t}function U(t){return Array.prototype.map.call(t,function(t){var e=t.toString(16);return 1===e.length&&(e="0"+e),e}).join("")}function S(t){return m(t.length%2==0,"hexstr.length must be even"),new Uint8Array(Array.prototype.map.call(t,function(e,n){return n%2==1?t[n-1]+e:""}).filter(function(t){return!!t}).map(function(t){return parseInt(t,16)}))}function V(t){return new TextDecoder("utf-8").decode(t)}function A(t){return new TextEncoder("utf-8").encode(t)}function L(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}var B=function(){function t(e){x()(this,t),b(e),this._buffer=e,this._dataview=new DataView(e.buffer,e.byteOffset,e.byteLength),this._pos=0}return _()(t,[{key:"length",value:function(){return this._buffer.byteLength}},{key:"tell",value:function(){return this._pos}},{key:"seek",value:function(t){this._pos=t,m(this._pos<=this.length(),"do not seek past end of buffer")}},{key:"incr",value:function(t){this.seek(this._pos+t)}},{key:"slice",value:function(t,e){var n=this._buffer.byteOffset+this._pos+t;return void 0===e&&(e=this.length()-this._pos),new Uint8Array(this._buffer.buffer,n,e)}}]),t}(),T=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"hasMoreBytes",value:function(){return this.tell()<this.length()}},{key:"readBytes",value:function(t){var e=this.slice(0,t);return this.incr(t),e}},{key:"readUint8",value:function(){var t=this._dataview.getUint8(this._pos);return this.incr(1),t}},{key:"readUint16",value:function(){var t=this._dataview.getUint16(this._pos);return this.incr(2),t}},{key:"readUint24",value:function(){var t=this._dataview.getUint16(this._pos);return t=t<<8|this._dataview.getUint8(this._pos+2),this.incr(3),t}},{key:"readUint32",value:function(){var t=this._dataview.getUint32(this._pos);return this.incr(4),t}},{key:"_readVector",value:function(t,e){var n=this.tell()+t,r=0;do{if(e(this,t,r))break;r+=1}while(this.tell()<n);this.tell()<n?this.seek(n):m(this.tell()===n,"read past end of vector")}},{key:"readVector8",value:function(t){var e=this.readUint8();return this._readVector(e,t)}},{key:"readVector16",value:function(t){var e=this.readUint16();return this._readVector(e,t)}},{key:"readVector24",value:function(t){var e=this.readUint24();return this._readVector(e,t)}},{key:"readVector32",value:function(t){var e=this.readUint32();return this._readVector(e,t)}},{key:"readWithLengthPrefix24",value:function(t){var e=!1;this.readVector24(function(){m(!e,"failed to read entire length-prefixed data"),e=!0,t.apply(void 0,arguments)})}},{key:"readVectorBytes8",value:function(){var t;return this.readVector8(function(e,n){t=e.readBytes(n)}),t}},{key:"readVectorBytes16",value:function(){var t;return this.readVector16(function(e,n){t=e.readBytes(n)}),t}},{key:"readVectorBytes24",value:function(){var t;return this.readVector24(function(e,n){t=e.readBytes(n)}),t}},{key:"readVectorBytes32",value:function(){var t;return this.readVector32(function(e,n){t=e.readBytes(n)}),t}}]),e}(B),O=function(t){function e(t){return x()(this,e),i()(this,s()(e).call(this,new Uint8Array(t)))}return f()(e,t),_()(e,[{key:"finalize",value:function(){var t=this.tell();return this.seek(0),this.slice(0,t)}},{key:"writeBytes",value:function(t){b(t),this._buffer.set(t,this.tell()),this.incr(t.byteLength)}},{key:"writeUint8",value:function(t){this._dataview.setUint8(this._pos,t),this.incr(1)}},{key:"writeUint16",value:function(t){this._dataview.setUint16(this._pos,t),this.incr(2)}},{key:"writeUint24",value:function(t){this._dataview.setUint16(this._pos,t>>8),this._dataview.setUint8(this._pos+2,255&t),this.incr(3)}},{key:"writeUint32",value:function(t){this._dataview.setUint32(this._pos,t),this.incr(4)}},{key:"_writeVector",value:function(t,e,n){var r=this.tell();e(0);var i=this.tell();n(this);var a=this.tell()-i;return m(a<=t,"wrote too many bytes for vector"),this.seek(r),e(a),this.incr(a),a}},{key:"writeVector8",value:function(t){return this._writeVector(Math.pow(2,8),this.writeUint8.bind(this),t)}},{key:"writeVector16",value:function(t){return this._writeVector(Math.pow(2,16),this.writeUint16.bind(this),t)}},{key:"writeVector24",value:function(t){return this._writeVector(Math.pow(2,24),this.writeUint24.bind(this),t)}},{key:"writeVector32",value:function(t){return this._writeVector(Math.pow(2,32),this.writeUint32.bind(this),t)}},{key:"writeVectorBytes8",value:function(t){return this.writeVector8(function(e){e.writeBytes(t)})}},{key:"writeVectorBytes16",value:function(t){return this.writeVector16(function(e){e.writeBytes(t)})}},{key:"writeVectorBytes24",value:function(t){return this.writeVector24(function(e){e.writeBytes(t)})}},{key:"writeVectorBytes32",value:function(t){return this.writeVector32(function(e){e.writeBytes(t)})}}]),e}(B),R=16,I=12,P=32;function H(t,e){return D.apply(this,arguments)}function D(){return(D=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",window.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,[n]));case 1:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function N(t,e,n,r,i){return M.apply(this,arguments)}function M(){return(M=v()(d.a.mark(function t(e,n,r,i,a){var s,c;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s=j(n,r),t.next=3,window.crypto.subtle.encrypt({name:"AES-GCM",iv:s,additionalData:a,tagLength:8*R},e,i);case 3:return c=t.sent,m(i.byteLength+R===c.byteLength,"incorrect AEAD_SIZE_INFLATION"),t.abrupt("return",new Uint8Array(c));case 6:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function C(t,e,n,r,i){return K.apply(this,arguments)}function K(){return(K=v()(d.a.mark(function t(e,n,r,i,a){var s,c;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s=j(n,r),t.next=3,window.crypto.subtle.decrypt({name:"AES-GCM",iv:s,additionalData:a,tagLength:8*R},e,i);case 3:return m((c=t.sent).byteLength+R===i.byteLength,"incorrect AEAD_SIZE_INFLATION"),t.abrupt("return",new Uint8Array(c));case 6:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function j(t,e){var n=new Uint8Array(I);new DataView(n.buffer).setUint32(I-4,e),m(t.byteLength===I,"provided IV has incorrect length");for(var r=0;r<I;r++)n[r]^=t[r];return n}function z(t){return G.apply(this,arguments)}function G(){return(G=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=Uint8Array,t.next=3,window.crypto.subtle.digest({name:"SHA-256"},e);case 3:return t.t1=t.sent,t.abrupt("return",new t.t0(t.t1));case 5:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function q(t,e){return F.apply(this,arguments)}function F(){return(F=v()(d.a.mark(function t(e,n){var r,i;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,window.crypto.subtle.importKey("raw",e,{hash:{name:"SHA-256"},name:"HMAC"},!1,["sign"]);case 2:return r=t.sent,t.next=5,window.crypto.subtle.sign({name:"HMAC"},r,n);case 5:return i=t.sent,t.abrupt("return",new Uint8Array(i));case 7:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function Y(t,e){return W.apply(this,arguments)}function W(){return(W=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,q(e,n);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function X(t,e,n){return Z.apply(this,arguments)}function Z(){return(Z=v()(d.a.mark(function t(e,n,r){var i,a,s,c,u;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m((i=Math.ceil(r/P))<255,"too much key material requested from hkdfExpand"),a=new O(P+n.byteLength+1),s=new O(i*P),c=new Uint8Array(0),u=1;case 6:if(!(u<=i)){t.next=17;break}return a.writeBytes(c),a.writeBytes(n),a.writeUint8(u),t.next=12,q(e,a.finalize());case 12:c=t.sent,s.writeBytes(c);case 14:u++,t.next=6;break;case 17:return m(s.tell()===i*P,"hkdfExpand generated too much data"),s.seek(0),t.abrupt("return",s.slice(0,r));case 20:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function J(t,e,n,r){return Q.apply(this,arguments)}function Q(){return(Q=v()(d.a.mark(function t(e,n,r,i){var a,s;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return E(n),b(r),a=2+(6+(1+n.length))+(1+r.byteLength),(s=new O(a)).writeUint16(i),s.writeVectorBytes8(A("tls13 "+n)),s.writeVectorBytes8(r),t.abrupt("return",X(e,s.finalize(),i));case 8:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}function $(t){return tt.apply(this,arguments)}function tt(){return(tt=v()(d.a.mark(function t(e){var n;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=new Uint8Array(e),crypto.getRandomValues(n),t.abrupt("return",n);case 3:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}var et={CLIENT_HELLO:1,SERVER_HELLO:2,ENCRYPTED_EXTENSIONS:8,FINISHED:20},nt=41,rt=43,it=45;function at(t){var e,n=t.readUint8(),r=t.readUint24()+t.tell();switch(n){case et.CLIENT_HELLO:e=ct._read(t);break;case et.SERVER_HELLO:e=ut._read(t);break;case et.ENCRYPTED_EXTENSIONS:e=ot._read(t);break;case et.FINISHED:e=ft._read(t);break;default:m(!1,"unexpected handshake message type")}return m(t.tell()===r,"failed to consume entire message"),e}var st=function(){function t(){x()(this,t)}return _()(t,[{key:"write",value:function(t){var e=this;t.writeUint8(this.TYPE_TAG),t.writeVector24(function(t){e._write(t)})}},{key:"_writeExtension",value:function(t,e,n){t.writeUint16(e),t.writeVector16(n)}}]),t}(),ct=function(t){function e(t,n,r,a){var c;return x()(this,e),(c=i()(this,s()(e).call(this))).random=t,c.sessionId=n,c.pskIds=r,c.pskBinders=a,m(32===t.byteLength,"random must be 32 bytes"),m(r.length===a.length,"incorrect number of psk binders"),c}return f()(e,t),_()(e,[{key:"_write",value:function(t){var e=this;t.writeUint16(771),t.writeBytes(this.random),t.writeVectorBytes8(this.sessionId),t.writeVector16(function(t){t.writeUint16(4865)}),t.writeVectorBytes8(new Uint8Array(1)),t.writeVector16(function(t){e._writeExtension(t,rt,function(t){t.writeVector8(function(t){t.writeUint16(772)})}),e._writeExtension(t,it,function(t){t.writeVector8(function(t){t.writeUint8(0)})}),e._writeExtension(t,nt,function(t){t.writeVector16(function(t){e.pskIds.forEach(function(e){t.writeVectorBytes16(e),t.writeUint32(0)})}),t.writeVector16(function(t){e.pskBinders.forEach(function(e){t.writeVectorBytes8(e)})})})})}},{key:"TYPE_TAG",get:function(){return et.CLIENT_HELLO}}],[{key:"_read",value:function(t){m(771===t.readUint16(),"unexpected legacy_version");var e=t.readBytes(32),n=t.readVectorBytes8(),r=!1;t.readVector16(function(t){if(4865===t.readUint16())return r=!0,!0}),m(r,"peer did not offer correct ciphersuite"),t.readVectorBytes8();var i=[],a=[];return t.readVector16(function(t){var e=t.readUint16();t.readVector16(function(t){switch(r=!1,e){case rt:t.readVector8(function(t){if(772===t.readUint16())return r=!0,!0}),m(r,"client claims not to support TLS1.3");break;case it:t.readVector8(function(t){if(0===t.readUint8())return r=!0,!0}),m(r,"client claims not to support PSK_MODE_KE");break;case nt:t.readVector16(function(t,e,n){var r=t.readVectorBytes16();t.readBytes(4),i.push(r)}),t.readVector16(function(t,e,n){var r=t.readVectorBytes8();m(r.byteLength>=32,"psk binder too short"),a.push(r)}),m(!t.hasMoreBytes(),"trailing data after PRE_SHARED_KEY extension");break;default:return!0}})}),new this(e,n,i,a)}}]),e}(st),ut=function(t){function e(t,n,r){var a;return x()(this,e),(a=i()(this,s()(e).call(this))).random=t,a.sessionId=n,a.pskIndex=r,m(32===t.byteLength,"random must be 32 bytes"),a}return f()(e,t),_()(e,[{key:"_write",value:function(t){var e=this;t.writeUint16(771),t.writeBytes(this.random),t.writeVectorBytes8(this.sessionId),t.writeUint16(4865),t.writeUint8(0),t.writeVector16(function(t){e._writeExtension(t,rt,function(t){t.writeUint16(772)}),e._writeExtension(t,nt,function(t){t.writeUint16(e.pskIndex)})})}},{key:"TYPE_TAG",get:function(){return et.SERVER_HELLO}}],[{key:"_read",value:function(t){m(771===t.readUint16(),"unexpected legacy_version");var e=t.readBytes(32),n=t.readVectorBytes8();m(4865===t.readUint16(),"illegal_parameter ciphersuite"),m(0===t.readUint8(),"unexpected legacy_compression_methods");var r=!1;return t.readVector16(function(t){var e=t.readUint16();t.readVector16(function(t){switch(e){case rt:m(772===t.readUint16(),"server does not support TLS1.3");break;case nt:r=t.readUint16();break;default:m(!1,"unexpected extension in ServerHello")}})}),m(!1!==r,"server did not select a PSK"),new this(e,n,r)}}]),e}(st),ot=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"_write",value:function(t){t.writeVector16(function(t){})}},{key:"TYPE_TAG",get:function(){return et.ENCRYPTED_EXTENSIONS}}],[{key:"_read",value:function(t){return t.readVector16(function(t,e){m(0===e,"unexpected encrypted extension")}),new this}}]),e}(st),ft=function(t){function e(t){var n;return x()(this,e),(n=i()(this,s()(e).call(this))).verifyData=t,m(t.byteLength===P,"incorrect length of verifyData"),n}return f()(e,t),_()(e,[{key:"_write",value:function(t){t.writeBytes(this.verifyData)}},{key:"TYPE_TAG",get:function(){return et.FINISHED}}],[{key:"_read",value:function(t){return new this(t.readBytes(P))}}]),e}(st),ht=function(){function t(e){x()(this,t),this.conn=e}return _()(t,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"sendApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this.conn._pendingApplicationData.push(e);case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvApplicationData",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"not ready to receive application data");case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"not expecting to receive a handhake message");case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"close",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"close() not implemented yet");case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()}]),t}(),pt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"uninitialized state");case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"sendApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"uninitialized state");case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"uninitialized state");case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"uninitialized state");case 1:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()},{key:"close",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:m(!1,"uninitialized state");case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()}]),e}(ht),lt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this.error=e;case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"sendApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:throw this.error;case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:throw this.error;case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:throw this.error;case 1:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()},{key:"close",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:throw this.error;case 1:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()}]),e}(ht),dt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(){var e;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(this.conn._pendingApplicationData.length>0)){t.next=6;break}return e=this.conn._pendingApplicationData.shift(),t.next=4,this.sendApplicationData(e);case 4:t.next=0;break;case 6:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"sendApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.conn._writeApplicationData(e);case 2:return t.next=4,this.conn._flushOutgoingRecord();case 4:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.slice(0));case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),yt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(){var e,n,r,i,a,s,c;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=new ct(this.conn.randomSalt,new Uint8Array(0),[this.conn.pskId],[new Uint8Array(32)]),t.next=3,this.conn._writeHandshakeMessage(e);case 3:return t.next=5,this.conn._deriveSecret("ext binder",new Uint8Array(0));case 5:return n=t.sent,t.next=8,J(n,"finished",new Uint8Array(0),P);case 8:return r=t.sent,i=this.conn._keyschedule.transcript,a=i.slice(-i.tell(),i.tell()-32-2-1),t.t0=q,t.t1=r,t.next=15,z(a);case 15:return t.t2=t.sent,t.next=18,(0,t.t0)(t.t1,t.t2);case 18:return m(32===(s=t.sent).byteLength,"incorrect pskBinder size"),i.incr(-32),i.writeBytes(s),(c=this.conn._recordSender._pendingRecordBuf).incr(-32),c.writeBytes(s),console.log("pskBinder was",s),t.next=28,this.conn._flushOutgoingRecord();case 28:return t.next=30,this.conn._transition(vt,e);case 30:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()}]),e}(ht),vt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this._clientHello=e;case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(e instanceof ut,"expected ServerHello"),m(L(e.sessionId,this._clientHello.sessionId),"server did not select our offered PSK"),m(0===e.pskIndex,"server did not select our offered PSK"),t.next=5,this.conn._keyschedule.addECDHE(null);case 5:return t.t0=this.conn,t.next=8,this.conn._deriveSecret("s hs traffic");case 8:return t.t1=t.sent,t.next=11,t.t0._setRecvKey.call(t.t0,t.t1);case 11:return t.t2=this.conn,t.next=14,this.conn._deriveSecret("c hs traffic");case 14:return t.t3=t.sent,t.next=17,t.t2._setSendKey.call(t.t2,t.t3);case 17:return t.next=19,this.conn._transition(wt,e);case 19:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),wt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(e instanceof ot,"expected EncryptedExtensions"),t.next=3,this.conn._transition(xt);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),xt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e){var n,r,i,a;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(e instanceof ft,"expected Finished"),t.t0=J,t.next=4,this.conn._deriveSecret("s hs traffic");case 4:return t.t1=t.sent,t.t2=new Uint8Array(0),t.t3=P,t.next=9,(0,t.t0)(t.t1,"finished",t.t2,t.t3);case 9:return n=t.sent,t.t4=q,t.t5=n,t.next=14,this.conn._keyschedule.getCurrentTranscriptHash();case 14:return t.t6=t.sent,t.next=17,(0,t.t4)(t.t5,t.t6);case 17:return r=t.sent,m(L(e.verifyData,r)),t.t7=J,t.next=22,this.conn._deriveSecret("c hs traffic");case 22:return t.t8=t.sent,t.t9=new Uint8Array(0),t.t10=P,t.next=27,(0,t.t7)(t.t8,"finished",t.t9,t.t10);case 27:return i=t.sent,t.t11=q,t.t12=i,t.next=32,this.conn._keyschedule.getCurrentTranscriptHash();case 32:return t.t13=t.sent,t.next=35,(0,t.t11)(t.t12,t.t13);case 35:return a=t.sent,t.next=38,this.conn._writeHandshakeMessage(new ft(a));case 38:return t.next=40,this.conn._flushOutgoingRecord();case 40:return t.next=42,this.conn._keyschedule.finalize();case 42:return t.t14=this.conn,t.next=45,this.conn._deriveSecret("s ap traffic");case 45:return t.t15=t.sent,t.next=48,t.t14._setRecvKey.call(t.t14,t.t15);case 48:return t.t16=this.conn,t.next=51,this.conn._deriveSecret("c ap traffic");case 51:return t.t17=t.sent,t.next=54,t.t16._setSendKey.call(t.t16,t.t17);case 54:return t.next=56,this.conn._transition(dt);case 56:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),kt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(e instanceof ct,"expected ClientHello"),t.next=3,this.conn._transition(_t,e);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),_t=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(e){var n,r,i,a,s,c,u,o=this;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(-1!==(n=e.pskIds.findIndex(function(t){return L(t,o.conn.pskId)})),"client did not offer a matching PSK"),r=e.pskBinders[n],console.log("pskBinder was",r),t.next=6,this.conn._deriveSecret("ext binder",new Uint8Array(0));case 6:return i=t.sent,t.next=9,J(i,"finished",new Uint8Array(0),P);case 9:return a=t.sent,s=this.conn._keyschedule.transcript,c=s.slice(-s.tell(),s.tell()-32-2-1),t.t0=q,t.t1=a,t.next=16,z(c);case 16:return t.t2=t.sent,t.next=19,(0,t.t0)(t.t1,t.t2);case 19:return u=t.sent,m(L(r,u),"incorrect pskBinder"),t.next=23,this.conn._transition(gt,e.sessionId,n);case 23:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),gt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(e,n){var r,i,a,s,c,u;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.conn._writeHandshakeMessage(new ut(this.conn.randomSalt,e,n));case 2:return t.next=4,this.conn._flushOutgoingRecord();case 4:return t.next=6,this.conn._keyschedule.addECDHE(null);case 6:return t.next=8,this.conn._deriveSecret("c hs traffic");case 8:return r=t.sent,t.next=11,this.conn._deriveSecret("s hs traffic");case 11:return i=t.sent,t.next=14,this.conn._setRecvKey(r);case 14:return t.next=16,this.conn._setSendKey(i);case 16:return t.next=18,this.conn._writeHandshakeMessage(new ot);case 18:return t.next=20,this.conn._flushOutgoingRecord();case 20:return t.next=22,J(i,"finished",new Uint8Array(0),P);case 22:return a=t.sent,t.t0=q,t.t1=a,t.next=27,this.conn._keyschedule.getCurrentTranscriptHash();case 27:return t.t2=t.sent,t.next=30,(0,t.t0)(t.t1,t.t2);case 30:return s=t.sent,t.next=33,this.conn._writeHandshakeMessage(new ft(s));case 33:return t.next=35,this.conn._flushOutgoingRecord();case 35:return t.next=37,J(r,"finished",new Uint8Array(0),P);case 37:return c=t.sent,t.t3=q,t.t4=c,t.next=42,this.conn._keyschedule.getCurrentTranscriptHash();case 42:return t.t5=t.sent,t.next=45,(0,t.t3)(t.t4,t.t5);case 45:return u=t.sent,t.next=48,this.conn._keyschedule.finalize();case 48:return t.t6=this.conn,t.next=51,this.conn._deriveSecret("s ap traffic");case 51:return t.t7=t.sent,t.next=54,t.t6._setSendKey.call(t.t6,t.t7);case 54:return t.t8=this.conn,t.t9=mt,t.t10=u,t.next=59,this.conn._deriveSecret("c ap traffic");case 59:return t.t11=t.sent,t.next=62,t.t8._transition.call(t.t8,t.t9,t.t10,t.t11);case 62:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()}]),e}(ht),mt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,[{key:"initialize",value:function(){var t=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this._clientVerifyData=e,this._pendingClientTrafficKey=n;case 2:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()},{key:"recvHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(e instanceof ft,"expected Finished"),m(L(e.verifyData,this._clientVerifyData)),t.next=4,this.conn._setRecvKey(this._pendingClientTrafficKey);case 4:return this._pendingClientTrafficKey=null,t.next=7,this.conn._transition(dt);case 7:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}]),e}(ht),bt={20:"CHANGE_CIPHER_SPEC",21:"ALERT",22:"HANDSHAKE",23:"APPLICATION_DATA"},Et=20,Ut=21,St=22,Vt=23,At=Math.pow(2,24),Lt=Math.pow(2,14),Bt=Lt+256,Tt=Bt+5,Ot=function(){function t(){x()(this,t),this.contentKey=null,this.contentIV=null,this.sequenceNumber=0}return _()(t,[{key:"setContentKey",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return b(e),t.t0=H,t.next=4,J(e,"key",new Uint8Array(0),16);case 4:return t.t1=t.sent,t.next=7,(0,t.t0)(t.t1,"decrypt");case 7:return this.contentKey=t.sent,t.next=10,J(e,"iv",new Uint8Array(0),I);case 10:this.contentIV=t.sent,this.sequenceNumber=0;case 12:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recv",value:function(){var t=v()(d.a.mark(function t(e){var n,r,i,a,s,c,u,o;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=new T(e),m((r=n.readUint8())in bt,"unrecognized record type"),n.readUint16(),i=n.readUint16(),null!==this.contentKey&&r!==Et){t.next=11;break}m(r!==Vt,"must encrypt application data"),m(i<Lt,"record_overflow"),a=n.readBytes(i),t.next=29;break;case 11:return m(i<Bt,"record_overflow"),m(r===Vt,"outer opaque_type should always be application data"),s=n.slice(-5,5),c=n.readBytes(i),t.next=17,this._decrypt(c,s);case 17:u=t.sent,o=u.byteLength-1;case 19:if(!(o>=0)){t.next=25;break}if(0===u[o]){t.next=22;break}return t.abrupt("break",25);case 22:o--,t.next=19;break;case 25:m(o>=0,"failed to find type byte in TLSInnerPlaintext"),m((r=u[o])!==Et,"change_cipher_spec records must be plaintext"),a=new Uint8Array(u.buffer,u.byteOffset,o);case 29:return m(!n.hasMoreBytes(),"record contained trailing data"),t.abrupt("return",[r,new T(a)]);case 31:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_decrypt",value:function(){var t=v()(d.a.mark(function t(e,n){var r;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,C(this.contentKey,this.contentIV,this.sequenceNumber,e,n);case 2:return r=t.sent,this.sequenceNumber+=1,m(this.sequenceNumber<At,"sequence number overflow"),t.abrupt("return",r);case 6:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()}]),t}(),Rt=function(){function t(){x()(this,t),this.contentKey=null,this.contentIV=null,this.sequenceNumber=0,this._pendingRecordType=0,this._pendingRecordBuf=null}return _()(t,[{key:"setContentKey",value:function(){var t=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return b(e),t.t0=H,t.next=4,J(e,"key",new Uint8Array(0),16);case 4:return t.t1=t.sent,t.next=7,(0,t.t0)(t.t1,"encrypt");case 7:return this.contentKey=t.sent,t.next=10,J(e,"iv",new Uint8Array(0),I);case 10:this.contentIV=t.sent,this.sequenceNumber=0;case 12:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()},{key:"withBufferWriter",value:function(){var t=v()(d.a.mark(function t(e,n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return null===this._pendingRecordBuf?(this._pendingRecordType=e,this._pendingRecordBuf=new O(Tt),this._pendingRecordBuf.incr(5)):m(this._pendingRecordType===e,"different record type already in progress"),t.next=3,n(this._pendingRecordBuf);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()},{key:"flush",value:function(){var t=v()(d.a.mark(function t(){var e,n,r,i,a;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this._pendingRecordBuf,n=this._pendingRecordType,this._pendingRecordBuf=null,m(null!==n,"no messages written to buffer"),r=e.tell()-5,null!==this.contentKey){t.next=13;break}m(n!==Vt,"must encrypt application data"),e.seek(0),e.writeUint8(n),e.writeUint16(771),e.writeUint16(r),t.next=26;break;case 13:return e.writeUint8(n),r+=1,e.seek(0),e.writeUint8(Vt),e.writeUint16(771),e.writeUint16(r+R),i=e.slice(-5,5),t.next=22,this._encrypt(e.slice(0,r),i);case 22:a=t.sent,r+=R,m(a.byteLength===r,"unexpected ciphertext length"),e.writeBytes(a);case 26:return e.seek(0),t.abrupt("return",e.slice(0,r+5));case 28:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_encrypt",value:function(){var t=v()(d.a.mark(function t(e,n){var r;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,N(this.contentKey,this.contentIV,this.sequenceNumber,e,n);case 2:return r=t.sent,this.sequenceNumber+=1,m(this.sequenceNumber<At,"sequence number overflow"),t.abrupt("return",r);case 6:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()}]),t}(),It=new Uint8Array(P),Pt=new Uint8Array(0),Ht=0,Dt=function(){function t(){x()(this,t),this.transcript=new O(1048576),this.secret=null,this.stage=Ht}return _()(t,[{key:"appendTranscriptMessage",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this.transcript.writeBytes(e);case 1:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"deriveSecret",value:function(){var t=v()(d.a.mark(function t(e){var n,r=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:void 0,t.t0=J,t.t1=this.secret,t.t2=e,t.next=6,this.getCurrentTranscriptHash(n);case 6:return t.t3=t.sent,t.t4=P,t.next=10,(0,t.t0)(t.t1,t.t2,t.t3,t.t4);case 10:return t.abrupt("return",t.sent);case 11:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"getCurrentTranscriptHash",value:function(){var t=v()(d.a.mark(function t(){var e,n=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=(e=n.length>0&&void 0!==n[0]?n[0]:void 0)||this.transcript.slice(-this.transcript.tell(),this.transcript.tell()),t.next=4,z(e);case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"addPSK",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=e||It,m(this.stage===Ht,"PSK added at incorrect state"),t.next=4,Y(It,e);case 4:this.secret=t.sent,this.stage=1;case 6:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"addECDHE",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=e||It,m(1===this.stage,"ECDHE added at incorrect state"),t.t0=Y,t.next=5,this.deriveSecret("derived",Pt);case 5:return t.t1=t.sent,t.t2=e,t.next=9,(0,t.t0)(t.t1,t.t2);case 9:this.secret=t.sent,this.stage=2;case 11:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"finalize",value:function(){var t=v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return m(2===this.stage,"finalized in incorrect state"),t.t0=Y,t.next=4,this.deriveSecret("derived",Pt);case 4:return t.t1=t.sent,t.t2=It,t.next=8,(0,t.t0)(t.t1,t.t2);case 8:this.secret=t.sent,this.stage=3;case 10:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()}]),t}();n.d(e,"InsecureClientConnection",function(){return Mt}),n.d(e,"InsecureServerConnection",function(){return Ct}),n.d(e,"bytesToHex",function(){return U}),n.d(e,"hexToBytes",function(){return S}),n.d(e,"bytesToUtf8",function(){return V}),n.d(e,"utf8ToBytes",function(){return A});var Nt=function(){function t(e,n,r,i){x()(this,t),this.psk=b(e),this.pskId=b(n),this.sendCallback=r,this.randomSalt=i,this._state=new pt(this),this._pendingApplicationData=[],this._recordSender=new Rt,this._recordReceiver=new Ot,this._keyschedule=new Dt,this._lastPromise=Promise.resolve()}return _()(t,[{key:"send",value:function(){var t=v()(d.a.mark(function t(e){var n=this;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return b(e),t.next=3,this._synchronized(v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n._state.sendApplicationData(e);case 2:case"end":return t.stop()}},t,this)})));case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"recv",value:function(){var t=v()(d.a.mark(function t(e){var n=this;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return b(e),t.next=3,this._synchronized(v()(d.a.mark(function t(){var r,i,a,s;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n._recordReceiver.recv(e);case 2:return r=t.sent,i=p()(r,2),a=i[0],s=i[1],t.next=8,n._dispatchIncomingRecord(a,s);case 8:return t.abrupt("return",t.sent);case 9:case"end":return t.stop()}},t,this)})));case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"close",value:function(){var t=v()(d.a.mark(function t(){var e=this;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._synchronized(v()(d.a.mark(function t(){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e._state.close();case 2:case"end":return t.stop()}},t,this)})));case 2:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_synchronized",value:function(t){var e=this,n=this._lastPromise.then(function(){return t()}).catch(function(){var t=v()(d.a.mark(function t(n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e._transition(lt,n);case 2:throw n;case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}());return this._lastPromise=n.then(g,g),n}},{key:"_transition",value:function(){var t=v()(d.a.mark(function t(e){var n,r,i,a,s=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(this._state=new e(this),r=s.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=s[a];return t.next=4,(n=this._state).initialize.apply(n,i);case 4:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_writeApplicationData",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._recordSender.withBufferWriter(Vt,function(){var t=v()(d.a.mark(function t(n){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.writeBytes(e);case 2:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}());case 2:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_writeHandshakeMessage",value:function(){var t=v()(d.a.mark(function t(e){var n=this;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._recordSender.withBufferWriter(St,function(){var t=v()(d.a.mark(function t(r){var i,a;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return i=r.tell(),t.next=3,e.write(r);case 3:a=r.tell(),n._keyschedule.appendTranscriptMessage(r.slice(i-a,a-i));case 5:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}());case 2:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_flushOutgoingRecord",value:function(){var t=v()(d.a.mark(function t(){var e;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._recordSender.flush();case 2:return e=t.sent,t.next=5,this.sendCallback(e);case 5:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_deriveSecret",value:function(){var t=v()(d.a.mark(function t(e){var n,r=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:void 0,t.next=3,this._keyschedule.deriveSecret(e,n);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_setRecvKey",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._recordReceiver.setContentKey(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_setSendKey",value:function(){var t=v()(d.a.mark(function t(e){return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._recordSender.setContentKey(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_dispatchIncomingRecord",value:function(){var t=v()(d.a.mark(function t(e,n){var r,i,a;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:t.t0=e,t.next=t.t0===Et?3:t.t0===Ut?6:t.t0===Vt?7:t.t0===St?10:18;break;case 3:return m(1===n.readUint8(),"unexpected_message"),m(!n.hasMoreBytes(),"unexpected_message"),t.abrupt("return",null);case 6:throw new Error("received TLS alert record, aborting!");case 7:return t.next=9,this._state.recvApplicationData(n);case 9:return t.abrupt("return",t.sent);case 10:return r=n.tell(),i=at(n),a=n.tell(),this._keyschedule.appendTranscriptMessage(n.slice(r-a,a-r)),t.next=16,this._state.recvHandshakeMessage(i);case 16:if(n.hasMoreBytes()){t.next=10;break}case 17:return t.abrupt("return",null);case 18:m(!1,"unknown record type: ".concat(e));case 19:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()}],[{key:"create",value:function(){var t=v()(d.a.mark(function t(e,n,r){var i,a,s=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(null!==(i=s.length>3&&void 0!==s[3]?s[3]:null)){t.next=7;break}return t.next=4,$(32);case 4:t.t0=t.sent,t.next=8;break;case 7:t.t0=i;case 8:return i=t.t0,a=new this(e,n,r,i),t.next=12,a._keyschedule.addPSK(e);case 12:return t.abrupt("return",a);case 13:case"end":return t.stop()}},t,this)}));return function(e,n,r){return t.apply(this,arguments)}}()}]),t}(),Mt=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,null,[{key:"create",value:function(){var t=v()(d.a.mark(function t(n,r,i){var a,c,o=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.length>3&&void 0!==o[3]?o[3]:null,t.next=3,u()(s()(e),"create",this).call(this,n,r,i,a);case 3:return c=t.sent,t.next=6,c._transition(yt);case 6:return t.abrupt("return",c);case 7:case"end":return t.stop()}},t,this)}));return function(e,n,r){return t.apply(this,arguments)}}()}]),e}(Nt),Ct=function(t){function e(){return x()(this,e),i()(this,s()(e).apply(this,arguments))}return f()(e,t),_()(e,null,[{key:"create",value:function(){var t=v()(d.a.mark(function t(n,r,i){var a,c,o=arguments;return d.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.length>3&&void 0!==o[3]?o[3]:null,t.next=3,u()(s()(e),"create",this).call(this,n,r,i,a);case 3:return c=t.sent,t.next=6,c._transition(kt);case 6:return t.abrupt("return",c);case 7:case"end":return t.stop()}},t,this)}));return function(e,n,r){return t.apply(this,arguments)}}()}]),e}(Nt)}])});